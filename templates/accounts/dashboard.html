{% extends "base.html" %}

{% block title %}Dashboard - ABASE{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
/* Force Dashboard Styles - Critical Priority */
.dashboard-override {
  background: var(--bg) !important;
  color: var(--text) !important;
  font-family: var(--font-sans) !important;
}
.dashboard-override .container-xl {
  max-width: 1280px !important;
  margin: 0 auto !important;
  padding: 1.5rem !important;
  min-height: 100vh !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 1.5rem !important;
}
.dashboard-override .card {
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  border-radius: 16px !important;
  box-shadow: var(--shadow) !important;
}
.dashboard-override .kpi {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 1rem !important;
  border-radius: 16px !important;
  background: linear-gradient(180deg,#121a2f,#0b1220) !important;
  border: 1px solid var(--border) !important;
}
.dashboard-override .row {
  display: grid !important;
  gap: 1rem !important;
  grid-template-columns: repeat(12,minmax(0,1fr)) !important;
}
.dashboard-override .col-3 { grid-column: span 3 !important; }
.dashboard-override .col-4 { grid-column: span 4 !important; }
.dashboard-override .col-6 { grid-column: span 6 !important; }
</style>
{% endblock %}

{% block content %}
  <!-- Header Section -->
  <header class="card" style="padding: 1.5rem;">
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
      <div>
        <h1 style="color: var(--heading); font-size: 2rem; font-weight: 700; margin: 0;">Dashboard Principal</h1>
        <p style="color: var(--muted); font-size: 0.875rem; margin: 0.25rem 0 0 0;">Visão geral do ecossistema ABASE</p>
      </div>

      <!-- Enhanced Filter Form -->
      <form method="get" style="background: var(--surface-2); border: 1px solid var(--border); border-radius: 12px; padding: 1rem;">
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: end;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <svg style="width: 1.25rem; height: 1.25rem; color: var(--accent);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8 7V3"/>
              <path d="M16 7V3"/>
              <path d="M4 9h16"/>
              <rect x="4" y="5" width="16" height="16" rx="2"/>
            </svg>
            <span style="color: var(--text); font-size: 0.875rem; font-weight: 500;">Período</span>
          </div>

          <div style="display: flex; gap: 0.75rem; align-items: center;">
            <label style="display: flex; flex-direction: column; gap: 0.25rem;">
              <span style="color: var(--muted); font-size: 0.75rem;">Início</span>
              <input
                type="date"
                name="data_inicio"
                value="{{ data_inicio|date:'Y-m-d' }}"
                class="input"
                style="min-width: 140px;"
              >
            </label>

            <span style="color: var(--muted); margin-top: 1.25rem;">→</span>

            <label style="display: flex; flex-direction: column; gap: 0.25rem;">
              <span style="color: var(--muted); font-size: 0.75rem;">Fim</span>
              <input
                type="date"
                name="data_fim"
                value="{{ data_fim|date:'Y-m-d' }}"
                class="input"
                style="min-width: 140px;"
              >
            </label>
          </div>

          <button type="submit" class="btn btn-accent" style="display: flex; align-items: center; gap: 0.5rem;">
            <svg style="width: 1rem; height: 1rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 4h18"/>
              <path d="M4 8h16"/>
              <path d="M6 12h12"/>
              <path d="M10 16h8"/>
              <path d="M12 20h6"/>
            </svg>
            Aplicar
          </button>
        </div>
      </form>
    </div>
  </header>

  <!-- KPI Cards Grid - Métricas Compactas -->
  <section class="row" style="margin-bottom: 1.5rem;">
    <!-- Total Usuários -->
    <article class="col-2">
      <div class="kpi" style="padding: 0.75rem; min-height: auto;">
        <div>
          <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.25rem;">Total de usuários</p>
          <p style="color: var(--heading); font-size: 1.25rem; font-weight: 700;">{{ total_users|default:0 }}</p>
        </div>
        <div style="background: rgba(96, 165, 250, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(96, 165, 250, 0.2);">
          <svg style="width: 1.25rem; height: 1.25rem; color: #93c5fd;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"/>
            <path d="M4 21v-2a6 6 0 0 1 6-6h4a6 6 0 0 1 6 6v2"/>
          </svg>
        </div>
      </div>
    </article>

    <!-- Associados Cadastrados -->
    <article class="col-2">
      <div class="kpi" style="padding: 0.75rem; min-height: auto;">
        <div>
          <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.25rem;">Associados</p>
          <p style="color: var(--heading); font-size: 1.25rem; font-weight: 700;">{{ total_associados|default:0 }}</p>
          {% if variacao_associados %}
          <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; {% if variacao_associados > 0 %}color: var(--success);{% else %}color: var(--danger);{% endif %}">
            {% if variacao_associados > 0 %}+{% endif %}{{ variacao_associados|floatformat:1 }}%
          </span>
          {% endif %}
        </div>
        <div style="background: rgba(122, 19, 64, 0.2); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(122, 19, 64, 0.3);">
          <svg style="width: 1.25rem; height: 1.25rem; color: #f4d6e3;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 20h5v-2a3 3 0 0 0-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 0 1 5.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 0 1 9.288 0"/>
            <path d="M15 7a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
          </svg>
        </div>
      </div>
    </article>

    <!-- Fundo Atual -->
    <article class="col-2">
      <div class="kpi" style="padding: 0.75rem; min-height: auto;">
        <div>
          <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.25rem;">Fundo atual</p>
          <p style="color: var(--heading); font-size: 1.25rem; font-weight: 700;">R$ {{ saldo_atual|floatformat:2|default:"0,00" }}</p>
        </div>
        <div style="background: rgba(22, 163, 74, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(22, 163, 74, 0.2);">
          <svg style="width: 1.25rem; height: 1.25rem; color: #86efac;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2"/>
            <path d="M12 6v14"/>
          </svg>
        </div>
      </div>
    </article>

    <!-- Retorno Estimado -->
    <article class="col-2">
      <div class="kpi" style="padding: 0.75rem; min-height: auto;">
        <div>
          <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.25rem;">Retorno estimado</p>
          <p style="color: var(--heading); font-size: 1.25rem; font-weight: 700;">R$ {{ retorno_estimado|floatformat:2|default:"0,00" }}</p>
        </div>
        <div style="background: rgba(167, 139, 250, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(167, 139, 250, 0.2);">
          <svg style="width: 1.25rem; height: 1.25rem; color: #c4b5fd;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 10c2-2 5-2 7 0s5 2 7 0 5-2 7 0"/>
            <path d="M3 16c2-2 5-2 7 0s5 2 7 0 5-2 7 0"/>
          </svg>
        </div>
      </div>
    </article>

    <!-- Taxas Mensais Pendentes -->
    <article class="col-2">
      <div class="kpi" style="padding: 0.75rem; min-height: auto;">
        <div>
          <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.25rem;">Taxas pendentes</p>
          <p style="color: var(--heading); font-size: 1.25rem; font-weight: 700;">R$ {{ taxas_mensais_pendentes|floatformat:2|default:"0,00" }}</p>
        </div>
        <div style="background: rgba(239, 68, 68, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(239, 68, 68, 0.2);">
          <svg style="width: 1.25rem; height: 1.25rem; color: #fca5a5;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
        </div>
      </div>
    </article>

    <!-- Disponível -->
    <article class="col-2">
      <div class="kpi" style="padding: 0.75rem; min-height: auto; opacity: 0.6;">
        <div>
          <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.25rem;">Disponível</p>
          <p style="color: var(--heading); font-size: 1.25rem; font-weight: 700;">—</p>
        </div>
        <div style="background: rgba(156, 163, 175, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(156, 163, 175, 0.2);">
          <svg style="width: 1.25rem; height: 1.25rem; color: #d1d5db;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
        </div>
      </div>
    </article>
  </section>

  <!-- Information Cards -->
  <section class="row">
    <!-- Tesouraria e Doações -->
    <article class="col-6">
      <div class="card" style="padding: 1.5rem;">
        <header style="margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
            <div style="background: rgba(22, 163, 74, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(22, 163, 74, 0.2);">
              <svg style="width: 1.25rem; height: 1.25rem; color: #86efac;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2"/>
                <path d="M12 6v14"/>
              </svg>
            </div>
            <div>
              <h2 class="section-title">Tesouraria e Doações</h2>
              <p style="color: var(--muted); font-size: 0.875rem;">Movimentação financeira consolidada</p>
            </div>
          </div>
        </header>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <div style="text-align: center;">
            <dt style="color: var(--muted); font-size: 0.75rem; margin-bottom: 0.25rem;">Total de entradas</dt>
            <dd style="color: var(--success); font-size: 1.125rem; font-weight: 600;">R$ {{ total_entradas|floatformat:2 }}</dd>
          </div>
          <div style="text-align: center;">
            <dt style="color: var(--muted); font-size: 0.75rem; margin-bottom: 0.25rem;">Total de saídas</dt>
            <dd style="color: var(--danger); font-size: 1.125rem; font-weight: 600;">R$ {{ total_saidas|floatformat:2 }}</dd>
          </div>
          <div style="text-align: center;">
            <dt style="color: var(--muted); font-size: 0.75rem; margin-bottom: 0.25rem;">Total de doações</dt>
            <dd style="color: var(--info); font-size: 1.125rem; font-weight: 600;">R$ {{ total_doacoes|floatformat:2 }}</dd>
          </div>
        </div>

        <footer style="padding-top: 1rem; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
          <span style="color: var(--muted); font-size: 0.875rem;">Fundo final</span>
          <span style="color: {% if saldo_atual >= 0 %}var(--success){% else %}var(--danger){% endif %}; font-size: 1.25rem; font-weight: 700;">
            R$ {{ saldo_atual|floatformat:2 }}
          </span>
        </footer>
      </div>
    </article>

    <!-- Perfil dos Associados -->
    <article class="col-6">
      <div class="card" style="padding: 1.5rem;">
        <header style="margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
            <div style="background: rgba(96, 165, 250, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(96, 165, 250, 0.2);">
              <svg style="width: 1.25rem; height: 1.25rem; color: #93c5fd;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 20h5v-2a3 3 0 0 0-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 0 1 5.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 0 1 9.288 0"/>
                <path d="M15 7a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
              </svg>
            </div>
            <div>
              <h2 class="section-title">Perfil dos Associados</h2>
              <p style="color: var(--muted); font-size: 0.875rem;">Atividade e tempo de aprovação</p>
            </div>
          </div>
        </header>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <div style="text-align: center;">
            <dt style="color: var(--muted); font-size: 0.75rem; margin-bottom: 0.25rem;">Total cadastrados</dt>
            <dd style="color: var(--info); font-size: 1.125rem; font-weight: 600;">{{ total_associados|default:0 }}</dd>
          </div>
          <div style="text-align: center;">
            <dt style="color: var(--muted); font-size: 0.75rem; margin-bottom: 0.25rem;">Associados ativos</dt>
            <dd style="color: var(--success); font-size: 1.125rem; font-weight: 600;">{{ associados_ativos|default:0 }}</dd>
          </div>
          <div style="text-align: center;">
            <dt style="color: var(--muted); font-size: 0.75rem; margin-bottom: 0.25rem;">Novos no período</dt>
            <dd style="color: var(--violet); font-size: 1.125rem; font-weight: 600;">{{ associados_periodo|default:0 }}</dd>
          </div>
        </div>

        {% if tempo_aprovacao %}
        <footer style="padding-top: 1rem; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
          <span style="color: var(--muted); font-size: 0.875rem;">Tempo médio de aprovação</span>
          <span style="color: var(--warn); font-size: 1.25rem; font-weight: 700;">{{ tempo_aprovacao.days }} dias</span>
        </footer>
        {% endif %}
      </div>
    </article>
  </section>

  <!-- Charts Grid - 2 Colunas x 3 Linhas -->
  <section class="row" style="margin-bottom: 1.5rem;">
    <!-- Status dos Processos -->
    <article class="col-6">
      <div class="card" style="padding: 1.25rem;">
        <header style="margin-bottom: 1rem;">
          <h2 class="section-title">Status dos Processos</h2>
          <p style="color: var(--muted); font-size: 0.875rem;">Distribuição por situação</p>
        </header>
        <div style="height: 14rem; display: flex; align-items: center; justify-content: center;">
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </article>

    <!-- Cadastros por Dia -->
    <article class="col-6">
      <div class="card" style="padding: 1.25rem;">
        <header style="margin-bottom: 1rem;">
          <h2 class="section-title">Cadastros por Dia</h2>
          <p style="color: var(--muted); font-size: 0.875rem;">Volume de solicitações recebidas</p>
        </header>
        <div style="height: 14rem;">
          <canvas id="cadastrosChart"></canvas>
        </div>
      </div>
    </article>
  </section>

  <section class="row" style="margin-bottom: 1.5rem;">
    <!-- Aprovações por Dia -->
    <article class="col-6">
      <div class="card" style="padding: 1.25rem;">
        <header style="margin-bottom: 1rem;">
          <h2 class="section-title">Aprovações por Dia</h2>
          <p style="color: var(--muted); font-size: 0.875rem;">Tendência de aprovações</p>
        </header>
        <div style="height: 14rem;">
          <canvas id="aprovacoesChart"></canvas>
        </div>
      </div>
    </article>

    <!-- Cargos dos Associados -->
    <article class="col-6">
      <div class="card" style="padding: 1.25rem;">
        <header style="margin-bottom: 1rem;">
          <h2 class="section-title">Cargos dos Associados</h2>
          <p style="color: var(--muted); font-size: 0.875rem;">Distribuição por função</p>
        </header>
        <div style="height: 14rem;">
          <canvas id="cargosChart"></canvas>
        </div>
      </div>
    </article>
  </section>

  <section class="row">
    <!-- Liquidações por Mês -->
    <article class="col-6">
      <div class="card" style="padding: 1.25rem;">
        <header style="margin-bottom: 1rem;">
          <h2 class="section-title">Liquidações por Mês</h2>
          <p style="color: var(--muted); font-size: 0.875rem;">Resultados financeiros liquidados</p>
        </header>
        <div style="height: 14rem;">
          <canvas id="liquidacoesChart"></canvas>
        </div>
      </div>
    </article>

    <!-- Progresso de Aprovação -->
    <article class="col-6">
      <div class="card" style="padding: 1.25rem;">
        <header style="margin-bottom: 1rem;">
          <h2 class="section-title">Progresso de Aprovação</h2>
          <p style="color: var(--muted); font-size: 0.875rem;">Etapas do fluxo de cadastro</p>
        </header>
        <div style="height: 14rem;">
          <canvas id="progressoChart"></canvas>
        </div>
      </div>
    </article>
  </section>

<script>
const statusData = {{ status_processos|safe }};
const cadastrosData = {{ cadastros_por_dia|safe }};
const aprovacoesData = {{ aprovacoes_por_dia|safe }};
const cargosData = {{ cargos_associados|safe }};
const liquidacoesData = {{ liquidadas_por_mes|safe }};
const progressoData = JSON.parse('{{ progresso_aprovacao|safe }}');

// Cores do Design System
const palette = {
  text: '#e5e7eb',        // var(--text)
  muted: '#94a3b8',       // var(--muted)
  grid: 'rgba(32, 42, 58, 0.3)',  // var(--border) com opacidade
  accent: '#7a1340',      // var(--accent)
  success: '#16a34a',     // var(--success)
  info: '#60a5fa',        // var(--info)
  warn: '#f59e0b',        // var(--warn)
  danger: '#ef4444',      // var(--danger)
  violet: '#a78bfa',      // var(--violet)
  neutral: '#94a3b8'      // var(--neutral)
};

Chart.defaults.color = palette.text;
Chart.defaults.font.family = 'Ubuntu, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif';
Chart.defaults.borderColor = palette.grid;
Chart.defaults.plugins.legend.labels.color = palette.muted;
Chart.defaults.plugins.legend.labels.boxWidth = 12;
Chart.defaults.plugins.legend.labels.boxHeight = 12;
Chart.defaults.plugins.legend.labels.usePointStyle = true;

function axisConfig(label) {
  return {
    ticks: { color: palette.muted },
    grid: { color: palette.grid },
    title: label ? { display: true, text: label, color: palette.muted } : undefined
  };
}

function buildDataset({ label, data, color, type = 'bar', fill = false, yAxisID }) {
  return {
    label,
    data,
    type,
    borderColor: color,
    backgroundColor: type === 'line' ? color : color + '33',
    tension: type === 'line' ? 0.35 : undefined,
    fill,
    borderWidth: type === 'line' ? 2 : 1,
    yAxisID
  };
}

if (statusData && statusData.length) {
  const ctx = document.getElementById('statusChart');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: statusData.map(item => item.status),
      datasets: [{
        data: statusData.map(item => item.total),
        backgroundColor: [palette.accent, palette.success, palette.info, palette.warn, palette.violet, palette.danger],
        borderColor: [palette.accent, palette.success, palette.info, palette.warn, palette.violet, palette.danger],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 16,
            font: {
              size: 12
            }
          }
        }
      }
    }
  });
}

if (cadastrosData && cadastrosData.length) {
  const ctx = document.getElementById('cadastrosChart');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: cadastrosData.map(item => new Date(item.dia).toLocaleDateString('pt-BR')),
      datasets: [buildDataset({ label: 'Cadastros', data: cadastrosData.map(item => item.total), color: palette.info })]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: axisConfig(),
        y: axisConfig('Total')
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
}

if (aprovacoesData && aprovacoesData.length) {
  const ctx = document.getElementById('aprovacoesChart');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: aprovacoesData.map(item => new Date(item.dia).toLocaleDateString('pt-BR')),
      datasets: [buildDataset({ label: 'Aprovações', data: aprovacoesData.map(item => item.total), color: palette.success, type: 'line', fill: true })]
    },
    options: {
      scales: {
        x: axisConfig(),
        y: axisConfig('Total')
      }
    }
  });
}

if (cargosData && cargosData.length) {
  const ctx = document.getElementById('cargosChart');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: cargosData.map(item => item.cargo_funcao),
      datasets: [buildDataset({ label: 'Quantidade', data: cargosData.map(item => item.total), color: palette.violet })]
    },
    options: {
      indexAxis: 'y',
      scales: {
        x: axisConfig('Total'),
        y: axisConfig()
      }
    }
  });
}

if (liquidacoesData && liquidacoesData.length) {
  const ctx = document.getElementById('liquidacoesChart');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: liquidacoesData.map(item => new Date(item.mes).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })),
      datasets: [buildDataset({ label: 'Liquidações', data: liquidacoesData.map(item => item.total), color: palette.warn, type: 'line', fill: true })]
    },
    options: {
      scales: {
        x: axisConfig(),
        y: axisConfig('Total')
      }
    }
  });
}

if (progressoData && progressoData.length) {
  const ctx = document.getElementById('progressoChart');
  new Chart(ctx, {
    data: {
      labels: progressoData.map(item => item.etapa),
      datasets: [
        buildDataset({ label: 'Total', data: progressoData.map(item => item.total), color: palette.accent, type: 'bar' }),
        buildDataset({ label: 'Percentual (%)', data: progressoData.map(item => item.percentual), color: palette.danger, type: 'line', yAxisID: 'y1' })
      ]
    },
    options: {
      maintainAspectRatio: false,
      scales: {
        x: axisConfig(),
        y: axisConfig('Quantidade'),
        y1: {
          ...axisConfig('Percentual'),
          position: 'right',
          max: 100,
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
}
</script>
{% endblock %}
