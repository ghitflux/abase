{% extends "base.html" %}
{% load static %}
{% load ui %}

{% block title %}Esteira de Análise{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-white mb-2">Esteira de Análise</h1>
    <p class="text-gray-400">Gerencie os processos pendentes, em análise e em correção - {{ count_total }} processos no total</p>
  </div>

  <!-- KPIs Dashboard -->
  <div class="mb-6">
    <section style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
      
      <!-- Processos Pendentes -->
      <article>
        <div class="card" style="padding: 1rem; height: 120px; display: flex; align-items: center; justify-content: space-between;">
          <div>
            <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem;">{{ kpis.pendentes.label }}</p>
            <p style="color: var(--heading); font-size: 1.5rem; font-weight: 700;">{{ kpis.pendentes.valor }}</p>
            {% if kpis.pendentes.variacao > 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--danger);">
                +{{ kpis.pendentes.variacao }}%
              </span>
            {% elif kpis.pendentes.variacao < 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--success);">
                {{ kpis.pendentes.variacao }}%
              </span>
            {% else %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--muted);">
                0%
              </span>
            {% endif %}
          </div>
          <div style="background: rgba(251, 146, 60, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(251, 146, 60, 0.2);">
            <svg style="width: 1.25rem; height: 1.25rem; color: #fb923c;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
        </div>
      </article>

      <!-- Em Análise -->
      <article>
        <div class="card" style="padding: 1rem; height: 120px; display: flex; align-items: center; justify-content: space-between;">
          <div>
            <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem;">{{ kpis.em_analise.label }}</p>
            <p style="color: var(--heading); font-size: 1.5rem; font-weight: 700;">{{ kpis.em_analise.valor }}</p>
            {% if kpis.em_analise.variacao > 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--info);">
                +{{ kpis.em_analise.variacao }}%
              </span>
            {% elif kpis.em_analise.variacao < 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--info);">
                {{ kpis.em_analise.variacao }}%
              </span>
            {% else %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--muted);">
                0%
              </span>
            {% endif %}
          </div>
          <div style="background: rgba(96, 165, 250, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(96, 165, 250, 0.2);">
            <svg style="width: 1.25rem; height: 1.25rem; color: #60a5fa;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
        </div>
      </article>

      <!-- Aprovados -->
      <article>
        <div class="card" style="padding: 1rem; height: 120px; display: flex; align-items: center; justify-content: space-between;">
          <div>
            <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem;">{{ kpis.aprovados.label }}</p>
            <p style="color: var(--heading); font-size: 1.5rem; font-weight: 700;">{{ kpis.aprovados.valor }}</p>
            {% if kpis.aprovados.variacao > 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--success);">
                +{{ kpis.aprovados.variacao }}%
              </span>
            {% elif kpis.aprovados.variacao < 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--danger);">
                {{ kpis.aprovados.variacao }}%
              </span>
            {% else %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--muted);">
                0%
              </span>
            {% endif %}
          </div>
          <div style="background: rgba(34, 197, 94, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(34, 197, 94, 0.2);">
            <svg style="width: 1.25rem; height: 1.25rem; color: #22c55e;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 13l4 4L19 7"/>
            </svg>
          </div>
        </div>
      </article>

      <!-- Tempo Médio -->
      <article>
        <div class="card" style="padding: 1rem; height: 120px; display: flex; align-items: center; justify-content: space-between;">
          <div>
            <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem;">{{ kpis.tempo_medio.label }}</p>
            <p style="color: var(--heading); font-size: 1.5rem; font-weight: 700;">{{ kpis.tempo_medio.valor }}{{ kpis.tempo_medio.sufixo|default:"" }}</p>
            {% if kpis.tempo_medio.variacao > 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--danger);">
                +{{ kpis.tempo_medio.variacao }}%
              </span>
            {% elif kpis.tempo_medio.variacao < 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--success);">
                {{ kpis.tempo_medio.variacao }}%
              </span>
            {% else %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--muted);">
                0%
              </span>
            {% endif %}
          </div>
          <div style="background: rgba(168, 85, 247, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(168, 85, 247, 0.2);">
            <svg style="width: 1.25rem; height: 1.25rem; color: #a855f7;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
        </div>
      </article>

      <!-- Taxa de Aprovação -->
      <article>
        <div class="card" style="padding: 1rem; height: 120px; display: flex; align-items: center; justify-content: space-between;">
          <div>
            <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem;">{{ kpis.taxa_aprovacao.label }}</p>
            <p style="color: var(--heading); font-size: 1.5rem; font-weight: 700;">{{ kpis.taxa_aprovacao.valor }}{{ kpis.taxa_aprovacao.sufixo|default:"" }}</p>
            {% if kpis.taxa_aprovacao.variacao > 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--success);">
                +{{ kpis.taxa_aprovacao.variacao }}%
              </span>
            {% elif kpis.taxa_aprovacao.variacao < 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--danger);">
                {{ kpis.taxa_aprovacao.variacao }}%
              </span>
            {% else %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--muted);">
                0%
              </span>
            {% endif %}
          </div>
          <div style="background: rgba(99, 102, 241, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(99, 102, 241, 0.2);">
            <svg style="width: 1.25rem; height: 1.25rem; color: #6366f1;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
          </div>
        </div>
      </article>

      <!-- Em Atraso -->
      <article>
        <div class="card" style="padding: 1rem; height: 120px; display: flex; align-items: center; justify-content: space-between;">
          <div>
            <p style="color: var(--muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem;">{{ kpis.em_atraso.label }}</p>
            <p style="color: var(--heading); font-size: 1.5rem; font-weight: 700;">{{ kpis.em_atraso.valor }}</p>
            {% if kpis.em_atraso.variacao > 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--danger);">
                +{{ kpis.em_atraso.variacao }}%
              </span>
            {% elif kpis.em_atraso.variacao < 0 %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--success);">
                {{ kpis.em_atraso.variacao }}%
              </span>
            {% else %}
              <span style="display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; font-weight: 500; color: var(--muted);">
                0%
              </span>
            {% endif %}
          </div>
          <div style="background: rgba(239, 68, 68, 0.15); padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(239, 68, 68, 0.2);">
            <svg style="width: 1.25rem; height: 1.25rem; color: #ef4444;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
          </div>
        </div>
      </article>

    </section>
  </div>

  <!-- Filtros Rápidos -->
<div class="mb-4">
  <div class="ds-pills">
    <a href="{% url 'analise:esteira' %}"
       class="ds-pill {% if not request.GET.status %}is-active{% endif %}">
      Todos
    </a>
    <a href="?status=pendente"
       class="ds-pill {% if request.GET.status == 'pendente' %}is-active{% endif %}"
       style="{% if request.GET.status == 'pendente' %}background: #3b2a0a; border-color: #713f12; color: #facc15;{% endif %}">
      Pendentes
    </a>
    <a href="?status=em_analise"
       class="ds-pill {% if request.GET.status == 'em_analise' %}is-active{% endif %}"
       style="{% if request.GET.status == 'em_analise' %}background: #1e293b; border-color: #334155; color: #93c5fd;{% endif %}">
      Em Análise
    </a>
    <a href="?status=em_correcao"
       class="ds-pill {% if request.GET.status == 'em_correcao' %}is-active{% endif %}"
       style="{% if request.GET.status == 'em_correcao' %}background: #3b1a0a; border-color: #7c2d12; color: #ffcf99;{% endif %}">
      Em Correção
    </a>
    <a href="?status=correcao_realizada"
       class="ds-pill {% if request.GET.status == 'correcao_realizada' %}is-active{% endif %}"
       style="{% if request.GET.status == 'correcao_realizada' %}background: #3a0f22; border-color: #7a134033; color: #ffd1e5;{% endif %}">
      Correção Realizada
    </a>
    <a href="?status=aprovado"
       class="ds-pill {% if request.GET.status == 'aprovado' %}is-active{% endif %}"
       style="{% if request.GET.status == 'aprovado' %}background: #052e1b; border-color: #065f46; color: #34d399;{% endif %}">
      Aprovados
    </a>
    <a href="?status=cancelado"
       class="ds-pill {% if request.GET.status == 'cancelado' %}is-active{% endif %}"
       style="{% if request.GET.status == 'cancelado' %}background: #3b0d0d; border-color: #7f1d1d; color: #fca5a5;{% endif %}">
      Cancelados
    </a>
  </div>
</div>

 <!-- Filtros -->
<div class="ds-card mb-4">
  <div class="p-3">
    <form id="filtros" method="get"
          hx-get="{% url 'analise:esteira' %}"
          hx-target="#blocks"
          hx-include="#filtros"
          hx-push-url="true"
          hx-trigger="submit">
      
      <!-- Layout responsivo: 2 linhas em mobile, 1 linha em desktop -->
      <div class="flex flex-col lg:flex-row gap-3">
        <!-- Primeira linha: Filtros principais -->
        <div class="flex flex-col sm:flex-row gap-3 flex-1">
          <div class="flex-1 min-w-0">
            <label class="ds-label text-sm mb-1">Analista</label>
            <select name="analista" class="ds-select h-9"
                    hx-get="{% url 'analise:esteira' %}"
                    hx-target="#blocks"
                    hx-include="#filtros"
                    hx-push-url="true"
                    hx-trigger="change">
              <option value="">Todos</option>
              {% for u in users %}
                <option value="{{ u.id }}" {% if request.GET.analista == u.id|stringformat:"s" %}selected{% endif %}>
                  {{ u.get_full_name|default:u.username }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="flex-1 min-w-0">
            <label class="ds-label text-sm mb-1">Agente</label>
            <select name="agente" class="ds-select h-9"
                    hx-get="{% url 'analise:esteira' %}"
                    hx-target="#blocks"
                    hx-include="#filtros"
                    hx-push-url="true"
                    hx-trigger="change">
              <option value="">Todos</option>
              {% for u in users %}
                <option value="{{ u.id }}" {% if request.GET.agente == u.id|stringformat:"s" %}selected{% endif %}>
                  {{ u.get_full_name|default:u.username }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        
        <!-- Segunda linha: Período de datas e busca -->
        <div class="flex flex-col sm:flex-row gap-3 flex-1">
          <div class="flex-1 min-w-0">
            <label class="ds-label text-sm mb-1">Data Início</label>
            <input type="date" name="data_inicio" value="{{ request.GET.data_inicio }}" class="ds-input h-9"
                   hx-get="{% url 'analise:esteira' %}"
                   hx-target="#blocks"
                   hx-include="#filtros"
                   hx-push-url="true"
                   hx-trigger="change">
          </div>
          <div class="flex-1 min-w-0">
            <label class="ds-label text-sm mb-1">Data Fim</label>
            <input type="date" name="data_fim" value="{{ request.GET.data_fim }}" class="ds-input h-9"
                   hx-get="{% url 'analise:esteira' %}"
                   hx-target="#blocks"
                   hx-include="#filtros"
                   hx-push-url="true"
                   hx-trigger="change">
          </div>
          <div class="flex-1 min-w-0">
            <label class="ds-label text-sm mb-1">Buscar</label>
            <input type="text" name="search" value="{{ request.GET.search }}" class="ds-input h-9"
                   placeholder="Nome, CPF/CNPJ, observações..."
                   hx-get="{% url 'analise:esteira' %}"
                   hx-target="#blocks"
                   hx-include="#filtros"
                   hx-push-url="true"
                   hx-trigger="keyup changed delay:500ms">
          </div>
        </div>
        
        <!-- Botões de ação alinhados à direita -->
        <div class="flex flex-col sm:flex-row gap-2 items-end justify-end min-w-fit">
          <button class="ds-btn ds-btn--accent whitespace-nowrap h-9 px-4 text-sm" type="submit">Aplicar Filtros</button>
          <a href="{% url 'analise:esteira' %}" class="ds-btn ds-btn--ghost whitespace-nowrap h-9 px-4 text-sm">Limpar</a>
        </div>
      </div>
    </form>
  </div>
</div>


  <!-- Blocos: containers com lógica de filtro -->
  <div id="blocks" class="space-y-6">
    <!-- Bloco Pendentes -->
    {% if not request.GET.status or request.GET.status == 'pendente' %}
   <div id="block-pendentes"
     hx-get="{% url 'analise:esteira_block' %}?block=pendentes&{{ request.GET.urlencode }}"
     hx-trigger="load delay:100ms"
     hx-swap="outerHTML">
  <div class="ds-card p-6">
    <div class="ds-skeleton">Carregando Pendentes...</div>
  </div>
</div>
    {% endif %}

    <!-- Bloco Em Análise -->
    {% if not request.GET.status or request.GET.status == 'em_analise' %}
    <div id="block-em_analise"
     hx-get="{% url 'analise:esteira_block' %}?block=em_analise&{{ request.GET.urlencode }}"
     hx-trigger="load delay:200ms"
     hx-swap="outerHTML">
  <div class="ds-card p-6">
    <div class="ds-skeleton">Carregando Em Análise...</div>
  </div>
</div>
    {% endif %}

    <!-- Bloco Em Correção -->
    {% if not request.GET.status or request.GET.status == 'em_correcao' %}
    <div id="block-em_correcao"
     hx-get="{% url 'analise:esteira_block' %}?block=em_correcao&{{ request.GET.urlencode }}"
     hx-trigger="load delay:300ms"
     hx-swap="outerHTML">
  <div class="ds-card p-6">
    <div class="ds-skeleton">Carregando Em Correção...</div>
  </div>
</div>
    {% endif %}

    <!-- Bloco Correção Realizada -->
    {% if not request.GET.status or request.GET.status == 'correcao_realizada' %}
    <div id="block-correcao_realizada"
     hx-get="{% url 'analise:esteira_block' %}?block=correcao_realizada&{{ request.GET.urlencode }}"
     hx-trigger="load delay:400ms"
     hx-swap="outerHTML">
  <div class="ds-card p-6">
    <div class="ds-skeleton">Carregando Correção Realizada...</div>
  </div>
</div>
    {% endif %}

    <!-- Bloco Aprovados -->
    {% if not request.GET.status or request.GET.status == 'aprovado' %}
    <div id="block-aprovado"
     hx-get="{% url 'analise:esteira_block' %}?block=aprovado&{{ request.GET.urlencode }}"
     hx-trigger="load delay:500ms"
     hx-swap="outerHTML">
  <div class="ds-card p-6">
    <div class="ds-skeleton">Carregando Aprovados...</div>
  </div>
</div>
    {% endif %}

    <!-- Bloco Cancelados -->
    {% if not request.GET.status or request.GET.status == 'cancelado' %}
    <div id="block-cancelado"
     hx-get="{% url 'analise:esteira_block' %}?block=cancelado&{{ request.GET.urlencode }}"
     hx-trigger="load delay:600ms"
     hx-swap="outerHTML">
  <div class="ds-card p-6">
    <div class="ds-skeleton">Carregando Cancelados...</div>
  </div>
</div>
    {% endif %}
  </div>
</div>
{% endblock %}
