{% extends "base.html" %}
{% load static %}
{% load ui %}
{% block title %}Lista de Cadastros • ABASE{% endblock %}

{% block content %}
    <div class="p-6">
         <div class="card" style="padding:1rem; margin-bottom:1rem; display:flex; justify-content:space-between; align-items:center;">
         <div class="section-title">Meus Cadastros</div>
         <a href="{% url 'cadastros:agente-create' %}" class="btn btn-accent">Novo Cadastro</a>
    </div>


    <!-- Alertas para cadastros pendentes de revisão -->
    {% if cadastros_pendentes %}
    {% if cadastros_pendentes %}
    <div class="card" style="padding:1rem; margin-bottom:1rem; border-left:4px solid var(--warn);">
        <div class="fw-600">Você tem {{ total_pendentes }} cadastro{{ total_pendentes|pluralize }} pendente{{ total_pendentes|pluralize }} de revisão</div>
        <div class="text-muted" style="margin-top:.25rem">Cadastros devolvidos pelo analista para correção. Verifique os comentários abaixo.</div>
    </div>
{% endif %}

    {% endif %}

    <!-- Estatísticas Rápidas -->
    <div class="row" style="margin-bottom:1rem">
        <div class="col-3 col-lg-12"><div class="kpi"><div>Total de Cadastros</div><div class="value-strong">{{ total_cadastros }}</div></div></div>
        <div class="col-3 col-lg-12"><div class="kpi"><div>Pendente de Revisão</div><div class="value-strong">{{ total_pendentes }}</div></div></div>
        <div class="col-3 col-lg-12"><div class="kpi"><div>Em Análise</div><div class="value-strong">{{ cadastros|length }}</div></div></div>
        <div class="col-3 col-lg-12"><div class="kpi"><div>Aprovados</div><div class="value-strong">0</div></div></div>
    </div>


    <!-- Lista de Cadastros -->
    {% if cadastros %}
    <div class="bg-white shadow rounded-lg overflow-hidden">
       <div class="card" style="padding:0">
  <div style="padding:1rem 1rem 0"><div class="section-title">Seus Cadastros</div></div>
  <div style="overflow-x:auto; padding:1rem">
    <table class="table table--dark">
      <thead>
        <tr>
          <th>Associado</th>
          <th>CPF/CNPJ</th>
          <th>Status</th>
          <th>Criado em</th>
          <th>Comentários do Analista</th>
          <th class="text-muted">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for cadastro in cadastros %}
          <tr {% if cadastro.status == 'PENDING_AGENT' %}style="outline:1px solid var(--warn); outline-offset:-1px"{% endif %}>
            <td>
              <div style="display:flex; align-items:center; gap:.75rem">
                <div style="width:40px;height:40px;border-radius:999px;background:#1f2937;display:flex;align-items:center;justify-content:center;">
                  <span class="fw-600">{{ cadastro.nome_completo|first|upper }}</span>
                </div>
                <div>
                  <div class="name-strong">{{ cadastro.nome_completo|truncatechars:30 }}</div>
                  <div class="text-muted">{{ cadastro.email|default:"Sem email" }}</div>
                </div>
              </div>
            </td>

            <td class="name-strong">{{ cadastro.cpf_cnpj|default:"Não informado" }}</td>

            <td>
              <span class="badge {{ cadastro.status|status_class }}">
                {{ cadastro.get_status_display|default:cadastro.status }}
              </span>
            </td>

            <td class="text-muted">{{ cadastro.created_at|date:"d/m/Y H:i" }}</td>

            <td>
              {% with processo=cadastro.analise_processo %}
                {% if processo and processo.feedback_agente %}
                  <div style="max-width:28ch">
                    <p class="text-muted" style="background:rgba(245,158,11,.1); padding:.5rem; border-radius:8px; border:1px solid rgba(245,158,11,.25)">
                      {{ processo.feedback_agente|truncatewords:10 }}
                    </p>
                    {% if processo.feedback_agente|length > 50 %}
                      <button onclick="showFullComment('{{ cadastro.id }}')" class="btn btn-ghost" style="padding:.25rem .5rem; margin-top:.25rem">
                        Ver completo
                      </button>
                    {% endif %}
                  </div>
                {% else %}
                  <span class="text-muted">Sem comentários</span>
                {% endif %}
              {% endwith %}
            </td>

            <td style="text-align:right">
              {% if cadastro.status == 'PENDING_AGENT' %}
                <a href="{% url 'cadastros:agente-create' %}?edit={{ cadastro.id }}" class="btn" style="margin-right:.5rem">Corrigir</a>
              {% endif %}
              <a href="{% url 'cadastros:agente-detail' cadastro.id %}" class="btn btn-accent">Ver Detalhes</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

    </div>
    {% else %}
    <div class="bg-white shadow rounded-lg">
        <div class="p-6">
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhum cadastro encontrado</h3>
                <p class="mt-1 text-sm text-gray-500">Comece criando um novo cadastro para seus associados.</p>
                <div class="mt-6">
                    <a href="{% url 'cadastros:agente-create' %}"
                       class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="-ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Novo Cadastro
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para exibir comentário completo -->
<div id="commentModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9998">
  <div class="card" style="position:relative; margin:10vh auto; padding:1rem; width:min(520px,92vw)">
    <div class="section-title" style="margin-bottom:.5rem">Comentário do Analista</div>
    <div id="fullComment" class="text-muted" style="background:rgba(245,158,11,.08); padding:.75rem; border-radius:10px; border:1px solid rgba(245,158,11,.2)">
    </div>
    <div style="margin-top:.75rem; display:flex; justify-content:flex-end">
      <button onclick="closeCommentModal()" class="btn">Fechar</button>
    </div>
  </div>
</div>

<script>
// Armazenar comentários completos
const fullComments = {
    {% for cadastro in cadastros %}
    {% with processo=cadastro.analise_processo %}
    {% if processo and processo.feedback_agente %}
    '{{ cadastro.id }}': '{{ processo.feedback_agente|escapejs }}',
    {% endif %}
    {% endwith %}
    {% endfor %}
};

function showFullComment(cadastroId) {
    const modal = document.getElementById('commentModal');
    const commentDiv = document.getElementById('fullComment');
    
    if (fullComments[cadastroId]) {
        commentDiv.textContent = fullComments[cadastroId];
        modal.classList.remove('hidden');
    }
}

function closeCommentModal() {
    document.getElementById('commentModal').classList.add('hidden');
}

// Fechar modal ao clicar fora dele
document.addEventListener('click', function(event) {
    const modal = document.getElementById('commentModal');
    if (event.target === modal) {
        modal.classList.add('hidden');
    }
});
</script>
{% endblock %}