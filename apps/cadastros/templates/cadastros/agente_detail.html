{% extends "base.html" %}
{% load static %}
{% load ui currency_filters %}

{% block title %}{{ cadastro.nome_completo }} - Detalhes{% endblock %}
{% block page_title %}Detalhes do Cadastro{% endblock %}

{% block content %}
<style>
  /* Accordion */
  details.accordion{
    border:1px solid var(--surface-2);
    border-radius:.75rem;
    background:var(--surface-1);
    margin-bottom:1rem;
    overflow:hidden;
  }
  details.accordion>summary{
    list-style:none; cursor:pointer;
    padding:.9rem 1rem; display:flex; align-items:center; justify-content:space-between;
    font-weight:600; user-select:none;
  }
  details.accordion>summary::-webkit-details-marker{display:none}
  details.accordion .chev{transition:transform .2s ease; opacity:.8; font-size:.9rem}
  details.accordion[open] .chev{transform:rotate(180deg)}
  details.accordion .body{padding:1rem; border-top:1px solid var(--surface-2)}

  /* Tipografia e contraste em dark */
  .field-label{color:var(--muted); font-size:.9rem}
  .field-value.name,
  .field-value.value{font-weight:600; color:var(--text, #e6e9f0)}
  .field-value.value{font-weight:700}

  /* Doc name claro */
  .doc-name{color:var(--text, #e6e9f0); font-weight:600}

  /* Coluna de ações no header */
  .side-actions{display:flex; flex-direction:column; align-items:flex-end; gap:.5rem}

  /* Endereço: grid estável + no-wrap p/ campos curtos */
  .no-wrap{white-space:nowrap}
</style>

<div class="container-xl" style="margin-top:1rem">

  <!-- HEADER -->
  <div class="card" style="padding:1rem; margin-bottom:1rem">
    <div style="display:flex; justify-content:space-between; gap:1rem; align-items:flex-start">
      <div>
        <div class="section-title">{{ cadastro.nome_completo }}</div>
        <div class="text-muted">
          CPF/CNPJ: {{ cadastro.cpf_cnpj }}
          {% if cadastro.matricula_servidor %} • Matrícula: {{ cadastro.matricula_servidor }}{% endif %}
        </div>
        {% if cadastro.created_at %}
          <div class="text-muted" style="margin-top:.25rem">Criado: {{ cadastro.created_at|date:"d/m/Y H:i" }}</div>
        {% endif %}
      </div>

      <div class="side-actions">
        {% if cadastro.status %}
          <span class="badge {{ cadastro.status|status_class }}">
            {{ cadastro.get_status_display|default:cadastro.status }}
          </span>
        {% endif %}
        {% if pode_renovar %}
          <a href="{% url 'cadastros:renovar-contrato' cadastro.id %}" class="btn btn-accent">Renovar Contrato</a>
        {% else %}
          <button class="btn btn-accent disabled" disabled title="Disponível após quitação das 3 mensalidades">
            Renovar Contrato
          </button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- MENSALIDADES (TOPO) -->
  {% if parcelas %}
  <div class="card" style="padding:1rem; margin-bottom:1rem">
    <div class="section-title" style="margin-bottom:.75rem">Mensalidades</div>
    <div class="row">
      {% for parcela in parcelas %}
      <div class="col-4 col-lg-12">
        <div class="card" style="padding:1rem; border:1px solid var(--surface-2)">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem">
            <div class="fw-600">{{ parcela.numero|default:forloop.counter }}ª Mensalidade</div>
            <span class="badge {{ parcela.status|status_class }}">{{ parcela.get_status_display|default:parcela.status }}</span>
          </div>

          <!-- valor claro -->
          <div class="field-value value" style="margin-bottom:.25rem">
            R$ {{ parcela.valor|currency_brl }}
          </div>

          {% if parcela.vencimento %}
            <div class="text-muted">Vencimento: {{ parcela.vencimento|date:"d/m/Y" }} (5º dia útil)</div>
            <div class="text-muted" style="font-size:.9em">{{ parcela.vencimento|days_until }}</div>
          {% else %}
            <div class="text-muted">Vencimento: Não informado</div>
          {% endif %}

          {% if parcela.observacao %}
            <div class="text-muted" style="font-size:.9em; margin-top:.5rem">Obs.: {{ parcela.observacao }}</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- COMENTÁRIO DO ANALISTA (ACCORDION – ABERTO) -->
  {% if processo_analise and processo_analise.feedback_agente %}
  <details class="accordion" open>
    <summary>
      Comentário do Analista
      <span class="chev">▾</span>
    </summary>
    <div class="body" style="background:rgba(245,158,11,.06)">
      <div class="text-muted">{{ processo_analise.feedback_agente }}</div>
    </div>
  </details>
  {% endif %}

  <!-- DADOS PESSOAIS (open) -->
  <details class="accordion" open>
    <summary>Dados Pessoais <span class="chev">▾</span></summary>
    <div class="body">
      <div class="row">
        <div class="col-6 col-lg-12">
          <div class="field-label">Nome/Razão Social</div>
          <div class="field-value name">{{ cadastro.nome_completo|default:"Não informado" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Tipo de Pessoa</div>
          <div class="field-value name">{{ cadastro.get_tipo_pessoa_display|default:"Não informado" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">CPF</div>
          <div class="field-value name no-wrap">{{ cadastro.cpf|default:"Não informado" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">CNPJ</div>
          <div class="field-value name no-wrap">{{ cadastro.cnpj|default:"Não informado" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">RG</div>
          <div class="field-value name no-wrap">{{ cadastro.rg|default:"Não informado" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Órgão Expedidor</div>
          <div class="field-value name">{{ cadastro.orgao_expedidor|default:"Não informado" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Data de Nascimento</div>
          <div class="field-value name no-wrap">{{ cadastro.data_nascimento|date:"d/m/Y"|default:"Não informado" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Estado Civil</div>
          <div class="field-value name">{{ cadastro.get_estado_civil_display|default:"Não informado" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Profissão</div>
          <div class="field-value name">{{ cadastro.profissao|default:"Não informado" }}</div>
        </div>
      </div>
    </div>
  </details>

  <!-- CONTATOS (open) -->
  <details class="accordion" open>
    <summary>Contatos <span class="chev">▾</span></summary>
    <div class="body">
      <div class="row">
        <div class="col-6 col-lg-12">
          <div class="field-label">Email</div>
          <div class="field-value name">{{ cadastro.email|default:"Não informado" }}</div>
        </div>
        <div class="col-6 col-lg-12">
          <div class="field-label">Celular</div>
          <div class="field-value name no-wrap">{{ cadastro.celular|default:"Não informado" }}</div>
        </div>
      </div>
    </div>
  </details>

  <!-- VÍNCULO PÚBLICO (open) -->
  <details class="accordion" open>
    <summary>Vínculo Público <span class="chev">▾</span></summary>
    <div class="body">
      <div class="row">
        <div class="col-6 col-lg-12">
          <div class="field-label">Órgão</div>
          <div class="field-value name">{{ cadastro.orgao_publico|default:"Não informado" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Situação do Servidor</div>
          <div class="field-value name">{{ cadastro.get_situacao_servidor_display|default:cadastro.situacao_servidor|default:"Não informado" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Matrícula</div>
          <div class="field-value name no-wrap">{{ cadastro.matricula_servidor|default:"Não informado" }}</div>
        </div>
      </div>
    </div>
  </details>

  <!-- ENDEREÇO (open) -->
  <details class="accordion" open>
    <summary>Endereço <span class="chev">▾</span></summary>
    <div class="body">
      <div class="row">
        <div class="col-4 col-lg-6">
          <div class="field-label">CEP</div>
          <div class="field-value name no-wrap">{{ cadastro.cep|default:"Não informado" }}</div>
        </div>
        <div class="col-8 col-lg-12">
          <div class="field-label">Logradouro</div>
          <div class="field-value name">{{ cadastro.endereco|default:"Não informado" }}</div>
        </div>

        <div class="col-2 col-lg-6">
          <div class="field-label">Número</div>
          <div class="field-value name no-wrap">{{ cadastro.numero|default:"-" }}</div>
        </div>
        <div class="col-4 col-lg-6">
          <div class="field-label">Complemento</div>
          <div class="field-value name">{{ cadastro.complemento|default:"-" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Bairro</div>
          <div class="field-value name">{{ cadastro.bairro|default:"-" }}</div>
        </div>
        <div class="col-5 col-lg-6">
          <div class="field-label">Cidade</div>
          <div class="field-value name">{{ cadastro.cidade|default:"-" }}</div>
        </div>
        <div class="col-2 col-lg-6">
          <div class="field-label">UF</div>
          <div class="field-value name no-wrap">{{ cadastro.uf|default:"-" }}</div>
        </div>
      </div>
    </div>
  </details>

  <!-- CONTA BANCÁRIA (open) -->
  <details class="accordion" open>
    <summary>Conta Bancária <span class="chev">▾</span></summary>
    <div class="body">
      <div class="row">
        <div class="col-4 col-lg-12">
          <div class="field-label">Banco</div>
          <div class="field-value name">{{ cadastro.banco|default:"Não informado" }}</div>
        </div>
        <div class="col-4 col-lg-6">
          <div class="field-label">Agência</div>
          <div class="field-value name no-wrap">{{ cadastro.agencia|default:"Não informado" }}</div>
        </div>
        <div class="col-4 col-lg-6">
          <div class="field-label">Conta</div>
          <div class="field-value name no-wrap">{{ cadastro.conta|default:"Não informado" }}</div>
        </div>
        <div class="col-4 col-lg-6">
          <div class="field-label">Tipo de Conta</div>
          <div class="field-value name">{{ cadastro.get_tipo_conta_display|default:cadastro.tipo_conta|default:"Não informado" }}</div>
        </div>
        <div class="col-8 col-lg-6">
          <div class="field-label">Chave PIX</div>
          <div class="field-value name">{{ cadastro.chave_pix|default:"Não informado" }}</div>
        </div>
      </div>
    </div>
  </details>

  <!-- FINANCEIRO (open) -->
  <details class="accordion" open>
    <summary>Financeiro <span class="chev">▾</span></summary>
    <div class="body">
      <div class="row">
        <div class="col-3 col-lg-6">
          <div class="field-label">Salário Bruto</div>
          <div class="field-value value">R$ {{ cadastro.valor_bruto_total|currency_brl }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Salário Líquido</div>
          <div class="field-value value">R$ {{ cadastro.valor_liquido|currency_brl }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Mensalidade Associativa</div>
          <div class="field-value value">R$ {{ cadastro.mensalidade_associativa|currency_brl }}</div>
        </div>

        <div class="col-3 col-lg-6">
          <div class="field-label">Prazo de Antecipação (meses)</div>
          <div class="field-value name no-wrap">{{ cadastro.prazo_antecipacao_meses|default:"-" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Taxa de Antecipação (%)</div>
          <div class="field-value name no-wrap">{{ cadastro.taxa_antecipacao_percent|default:"-" }}</div>
        </div>
        <div class="col-3 col-lg-6">
          <div class="field-label">Auxílio do Agente (%)</div>
          <div class="field-value name no-wrap">{{ cadastro.auxilio_agente_taxa_percent|default:"-" }}</div>
        </div>
      </div>
    </div>
  </details>

  <!-- DOCUMENTOS (open) -->
  <details class="accordion" open>
    <summary>Documentos Anexados <span class="chev">▾</span></summary>
    <div class="body">
      {% if documentos %}
        <div class="row">
          {% for documento in documentos %}
          <div class="col-6 col-lg-12">
            <div class="card" style="padding:.75rem; display:flex; justify-content:space-between; align-items:center">
              <div>
                <div class="doc-name">{{ documento.tipo|default:"Documento" }}</div>
                <div class="text-muted" style="font-size:.9em">{{ documento.created_at|date:"d/m/Y H:i" }}</div>
              </div>
              <a href="{% url 'documentos:serve' %}?path={{ documento.arquivo.name }}" target="_blank" class="btn btn-ghost">Ver</a>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">Nenhum documento anexado.</div>
      {% endif %}
    </div>
  </details>

</div>
{% endblock %}
