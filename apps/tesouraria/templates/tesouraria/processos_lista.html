{% extends "base.html" %}
{% load static %}
{% load ui %}

{% block title %}Processos da Tesouraria{% endblock %}

{% block content %}
<!-- Modal de Detalhes removido - substituído pelo modal centrado no final -->

<div class="container mx-auto px-4 py-6">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-white mb-2">Processos da Tesouraria</h1>
    <p class="text-gray-400">Gerencie os processos aprovados pela análise - {{ kpis.total_processos.valor }} processos no total</p>
  </div>

  <!-- KPIs Dashboard -->
  <div class="mb-6">
    <div class="ds-card p-4">
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        
        <!-- Total de Processos -->
        <div class="flex items-center space-x-3 p-3 rounded-lg bg-blue-50 border border-blue-200">
          <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
            </svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs font-medium text-blue-700 truncate">{{ kpis.total_processos.label }}</p>
            <p class="text-lg font-bold text-blue-900">{{ kpis.total_processos.valor }}</p>
          </div>
        </div>

        <!-- Pendentes -->
        <div class="flex items-center space-x-3 p-3 rounded-lg bg-yellow-50 border border-yellow-200">
          <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs font-medium text-yellow-700 truncate">{{ kpis.pendentes.label }}</p>
            <p class="text-lg font-bold text-yellow-900">{{ kpis.pendentes.valor }}</p>
          </div>
        </div>

        <!-- Processados -->
        <div class="flex items-center space-x-3 p-3 rounded-lg bg-green-50 border border-green-200">
          <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs font-medium text-green-700 truncate">{{ kpis.processados.label }}</p>
            <p class="text-lg font-bold text-green-900">{{ kpis.processados.valor }}</p>
          </div>
        </div>

        <!-- Rejeitados -->
        <div class="flex items-center space-x-3 p-3 rounded-lg bg-red-50 border border-red-200">
          <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs font-medium text-red-700 truncate">{{ kpis.rejeitados.label }}</p>
            <p class="text-lg font-bold text-red-900">{{ kpis.rejeitados.valor }}</p>
          </div>
        </div>

        <!-- Valor Total Liberado -->
        <div class="flex items-center space-x-3 p-3 rounded-lg bg-green-50 border border-green-200">
          <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs font-medium text-green-700 truncate">{{ kpis.valor_liberado.label }}</p>
            <p class="text-lg font-bold text-green-900">R$ {{ kpis.valor_liberado.valor|floatformat:2 }}</p>
          </div>
        </div>

        <!-- Auxílio aos Agentes -->
        <div class="flex items-center space-x-3 p-3 rounded-lg bg-blue-50 border border-blue-200">
          <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
            </svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs font-medium text-blue-700 truncate">{{ kpis.valor_auxilio.label }}</p>
            <p class="text-lg font-bold text-blue-900">R$ {{ kpis.valor_auxilio.valor|floatformat:2 }}</p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="ds-card p-6 mb-6" x-data="{ 
    showAdvanced: false,
    filters: {
      status: '{{ current_filters.status }}',
      agente: '{{ current_filters.agente }}',
      search: '{{ current_filters.search }}',
      data_inicio: '',
      data_fim: '',
      valor_min: '',
      valor_max: '',
      tipo_pessoa: '',
      ordenacao: 'data_entrada'
    },
    quickFilter: '',
    setQuickFilter(status) {
      this.quickFilter = status;
      this.filters.status = status;
      this.applyFilters();
    },
    clearFilters() {
      this.filters = {
        status: '',
        agente: '',
        search: '',
        data_inicio: '',
        data_fim: '',
        valor_min: '',
        valor_max: '',
        tipo_pessoa: '',
        ordenacao: 'data_entrada'
      };
      this.quickFilter = '';
      this.applyFilters();
    },
    applyFilters() {
      const params = new URLSearchParams();
      Object.keys(this.filters).forEach(key => {
        if (this.filters[key]) {
          params.append(key, this.filters[key]);
        }
      });
      window.location.search = params.toString();
    }
  }">
    
    <!-- Filtros Rápidos -->
  <div class="mb-4">
    <div class="ds-pills">
      <a href="{% url 'tesouraria:processos' %}"
         class="ds-pill {% if not request.GET.status %}is-active{% endif %}">
        Todos
      </a>
      <a href="?status=pendente"
         class="ds-pill {% if request.GET.status == 'pendente' %}is-active{% endif %}"
         style="{% if request.GET.status == 'pendente' %}background: #3b2a0a; border-color: #713f12; color: #facc15;{% endif %}">
        Pendentes
      </a>
      <a href="?status=em_validacao_video"
         class="ds-pill {% if request.GET.status == 'em_validacao_video' %}is-active{% endif %}"
         style="{% if request.GET.status == 'em_validacao_video' %}background: #1e3a8a; border-color: #3b82f6; color: #93c5fd;{% endif %}">
        Em Validação Vídeo
      </a>
      <a href="?status=em_averbacao"
         class="ds-pill {% if request.GET.status == 'em_averbacao' %}is-active{% endif %}"
         style="{% if request.GET.status == 'em_averbacao' %}background: #581c87; border-color: #9333ea; color: #c4b5fd;{% endif %}">
        Em Averbação
      </a>
      <a href="?status=processado"
         class="ds-pill {% if request.GET.status == 'processado' %}is-active{% endif %}"
         style="{% if request.GET.status == 'processado' %}background: #052e1b; border-color: #065f46; color: #34d399;{% endif %}">
        Processados
      </a>
      <a href="?status=rejeitado"
         class="ds-pill {% if request.GET.status == 'rejeitado' %}is-active{% endif %}"
         style="{% if request.GET.status == 'rejeitado' %}background: #3b0d0d; border-color: #7f1d1d; color: #fca5a5;{% endif %}">
        Rejeitados
      </a>
    </div>
  </div>

    <!-- Filtros -->
    <div class="ds-card mb-4">
      <div class="p-3">
        <form id="filtros" method="get"
              hx-get="{% url 'tesouraria:processos' %}"
              hx-target="#processos-container"
              hx-include="#filtros"
              hx-push-url="true"
              hx-trigger="submit">
          
          <!-- Layout responsivo: 2 linhas em mobile, 1 linha em desktop -->
          <div class="flex flex-col lg:flex-row gap-3">
            <!-- Primeira linha: Filtros principais -->
            <div class="flex flex-col sm:flex-row gap-3 flex-1">
              <div class="flex-1 min-w-0">
                <label class="ds-label text-sm mb-1">Agente</label>
                <select name="agente" class="ds-select h-9"
                        hx-get="{% url 'tesouraria:processos' %}"
                        hx-target="#processos-container"
                        hx-include="#filtros"
                        hx-push-url="true"
                        hx-trigger="change">
                  <option value="">Todos</option>
                  {% for agente in agentes %}
                    <option value="{{ agente.id }}" {% if request.GET.agente == agente.id|stringformat:"s" %}selected{% endif %}>
                      {{ agente.get_full_name|default:agente.username }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="flex-1 min-w-0">
                <label class="ds-label text-sm mb-1">Status</label>
                <select name="status" class="ds-select h-9"
                        hx-get="{% url 'tesouraria:processos' %}"
                        hx-target="#processos-container"
                        hx-include="#filtros"
                        hx-push-url="true"
                        hx-trigger="change">
                  <option value="">Todos</option>
                  <option value="pendente" {% if request.GET.status == 'pendente' %}selected{% endif %}>Pendente</option>
                  <option value="em_validacao_video" {% if request.GET.status == 'em_validacao_video' %}selected{% endif %}>Em Validação Vídeo</option>
                  <option value="em_averbacao" {% if request.GET.status == 'em_averbacao' %}selected{% endif %}>Em Averbação</option>
                  <option value="processado" {% if request.GET.status == 'processado' %}selected{% endif %}>Processado</option>
                  <option value="rejeitado" {% if request.GET.status == 'rejeitado' %}selected{% endif %}>Rejeitado</option>
                </select>
              </div>
            </div>
            
            <!-- Segunda linha: Período de datas e busca -->
            <div class="flex flex-col sm:flex-row gap-3 flex-1">
              <div class="flex-1 min-w-0">
                <label class="ds-label text-sm mb-1">Data Início</label>
                <input type="date" name="data_inicio" value="{{ request.GET.data_inicio }}" class="ds-input h-9"
                       hx-get="{% url 'tesouraria:processos' %}"
                       hx-target="#processos-container"
                       hx-include="#filtros"
                       hx-push-url="true"
                       hx-trigger="change">
              </div>
              <div class="flex-1 min-w-0">
                <label class="ds-label text-sm mb-1">Data Fim</label>
                <input type="date" name="data_fim" value="{{ request.GET.data_fim }}" class="ds-input h-9"
                       hx-get="{% url 'tesouraria:processos' %}"
                       hx-target="#processos-container"
                       hx-include="#filtros"
                       hx-push-url="true"
                       hx-trigger="change">
              </div>
              <div class="flex-1 min-w-0">
                <label class="ds-label text-sm mb-1">Buscar</label>
                <input type="text" name="search" value="{{ request.GET.search }}" class="ds-input h-9"
                       placeholder="Nome, CPF/CNPJ, matrícula..."
                       hx-get="{% url 'tesouraria:processos' %}"
                       hx-target="#processos-container"
                       hx-include="#filtros"
                       hx-push-url="true"
                       hx-trigger="keyup changed delay:500ms">
              </div>
            </div>
            
            <!-- Botões de ação alinhados à direita -->
            <div class="flex flex-col sm:flex-row gap-2 items-end justify-end min-w-fit">
              <button class="ds-btn ds-btn--accent whitespace-nowrap h-9 px-4 text-sm" type="submit">Aplicar Filtros</button>
              <a href="{% url 'tesouraria:processos' %}" class="ds-btn ds-btn--ghost whitespace-nowrap h-9 px-4 text-sm">Limpar</a>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Filtros Avançados -->
    <div x-show="showAdvanced" x-transition class="border-t border-gray-200 pt-4">
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
        <div>
          <label class="ds-label">Data de Entrada (Início)</label>
          <input type="date" x-model="filters.data_inicio" class="ds-input">
        </div>
        
        <div>
          <label class="ds-label">Data de Entrada (Fim)</label>
          <input type="date" x-model="filters.data_fim" class="ds-input">
        </div>
        
        <div>
          <label class="ds-label">Valor Mínimo</label>
          <input type="number" x-model="filters.valor_min" placeholder="0,00" class="ds-input">
        </div>
        
        <div>
          <label class="ds-label">Valor Máximo</label>
          <input type="number" x-model="filters.valor_max" placeholder="0,00" class="ds-input">
        </div>
        
        <div>
          <label class="ds-label">Ordenação</label>
          <select x-model="filters.ordenacao" class="ds-input">
            <option value="data_entrada">Data de Entrada</option>
            <option value="-data_entrada">Data de Entrada (Desc)</option>
            <option value="cadastro__disponivel">Valor Liberado</option>
            <option value="-cadastro__disponivel">Valor Liberado (Desc)</option>
            <option value="status">Status</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Filtros Ativos -->
    <div class="mt-4" x-show="Object.values(filters).some(v => v !== '')">
      <div class="flex flex-wrap gap-2 items-center">
        <span class="text-sm text-gray-600">Filtros ativos:</span>
        <template x-for="[key, value] in Object.entries(filters)" :key="key">
          <span x-show="value" class="ds-badge-info text-xs">
            <span x-text="key + ': ' + value"></span>
            <button @click="filters[key] = ''; applyFilters()" class="ml-1 text-blue-400 hover:text-blue-600">×</button>
          </span>
        </template>
      </div>
    </div>
  </div>

  <!-- Conteúdo dos Processos -->
  <div id="processos-container">
    <div class="space-y-6">
      <!-- Tabela de Processos Pendentes -->
      {% if not request.GET.status or request.GET.status == 'pendente' %}
      {% if processos_pendentes %}
      <div id="block-pendentes"
           hx-get="{% url 'tesouraria:processo_block' %}?block=pendentes&{{ request.GET.urlencode }}"
           hx-trigger="load delay:100ms"
           hx-swap="outerHTML">
        <div class="ds-card p-6">
          <div class="ds-skeleton">Carregando Pendentes...</div>
        </div>
      </div>
      {% endif %}
      {% endif %}

      <!-- Tabela de Processos Em Validação Vídeo -->
      {% if not request.GET.status or request.GET.status == 'em_validacao_video' %}
      {% if processos_em_validacao_video %}
      <div id="block-em-validacao-video"
           hx-get="{% url 'tesouraria:processo_block' %}?block=em_validacao_video&{{ request.GET.urlencode }}"
           hx-trigger="load delay:150ms"
           hx-swap="outerHTML">
        <div class="ds-card p-6">
          <div class="ds-skeleton">Carregando Em Validação Vídeo...</div>
        </div>
      </div>
      {% endif %}
      {% endif %}

      <!-- Tabela de Processos Em Averbação -->
      {% if not request.GET.status or request.GET.status == 'em_averbacao' %}
      {% if processos_em_averbacao %}
      <div id="block-em-averbacao"
           hx-get="{% url 'tesouraria:processo_block' %}?block=em_averbacao&{{ request.GET.urlencode }}"
           hx-trigger="load delay:200ms"
           hx-swap="outerHTML">
        <div class="ds-card p-6">
          <div class="ds-skeleton">Carregando Em Averbação...</div>
        </div>
      </div>
      {% endif %}
      {% endif %}

      <!-- Tabela de Processos Processados -->
      {% if not request.GET.status or request.GET.status == 'processado' %}
      {% if processos_processados %}
      <div id="block-processados"
           hx-get="{% url 'tesouraria:processo_block' %}?block=processados&{{ request.GET.urlencode }}"
           hx-trigger="load delay:250ms"
           hx-swap="outerHTML">
        <div class="ds-card p-6">
          <div class="ds-skeleton">Carregando Processados...</div>
        </div>
      </div>
      {% endif %}
      {% endif %}

      <!-- Tabela de Processos Rejeitados -->
      {% if not request.GET.status or request.GET.status == 'REJEITADO' %}
      {% if processos_rejeitados %}
      <div id="block-rejeitados"
           hx-get="{% url 'tesouraria:processo_block' %}?block=rejeitados&{{ request.GET.urlencode }}"
           hx-trigger="load delay:300ms"
           hx-swap="outerHTML">
        <div class="ds-card p-6">
          <div class="ds-skeleton">Carregando Rejeitados...</div>
        </div>
      </div>
      {% endif %}
      {% endif %}
    </div>
  </div>

  <!-- Paginação -->
  {% if page_obj.has_other_pages %}
    <div class="ds-card mt-6">
      <div class="px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex-1 flex justify-between sm:hidden">
             {% if page_obj.has_previous %}
               <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}" 
                  class="ds-btn-secondary">Anterior</a>
             {% endif %}
             {% if page_obj.has_next %}
               <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}" 
                  class="ds-btn-secondary">Próximo</a>
             {% endif %}
           </div>
          <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
              <p class="text-sm text-gray-700">
                Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ page_obj.paginator.count }} processos
              </p>
            </div>
            <div>
              <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                 {% if page_obj.has_previous %}
                   <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}" 
                      class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                     <span class="sr-only">Anterior</span>
                     <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                       <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                     </svg>
                   </a>
                 {% endif %}
                 
                 {% for num in page_obj.paginator.page_range %}
                   {% if page_obj.number == num %}
                     <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600">
                       {{ num }}
                     </span>
                   {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                     <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}" 
                        class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                       {{ num }}
                     </a>
                   {% endif %}
                 {% endfor %}
                 
                 {% if page_obj.has_next %}
                   <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}" 
                      class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                     <span class="sr-only">Próximo</span>
                     <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                       <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                     </svg>
                   </a>
                 {% endif %}
               </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

</div>

<!-- Modal de Detalhes do Processo -->
<div id="processo-modal" class="fixed inset-0 bg-black/50 opacity-0 invisible z-50 transition-all duration-300" onclick="closeModal(event)" style="z-index: 9999;">
  <div class="flex items-center justify-center min-h-screen px-4 py-8" onclick="event.stopPropagation()">
    <div class="bg-card rounded-lg shadow-xl w-full border border-border theme-transition transform scale-95 transition-transform duration-300" style="width: 95% !important; max-width: 1200px !important; max-height: 85vh !important; overflow: hidden !important; display: flex !important; flex-direction: column !important;">
      <div id="modal-content" class="flex-1 overflow-y-auto">
        <!-- Conteúdo carregado via AJAX -->
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmação -->
<div id="confirmation-modal" class="fixed inset-0 bg-black/50 opacity-0 invisible z-50 transition-all duration-300" style="z-index: 10000;">
  <div class="flex items-center justify-center min-h-screen px-4 py-8">
    <div class="ds-modal w-full max-w-md transform scale-95 transition-transform duration-300">
      <!-- Header com ícone -->
      <div class="p-6 text-center">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center" id="confirmation-icon">
          <!-- Ícone será inserido dinamicamente -->
        </div>
        <h3 class="text-lg font-semibold ds-modal-title mb-2" id="confirmation-title">Confirmar Ação</h3>
        <p class="ds-modal-muted mb-4" id="confirmation-message">Tem certeza que deseja realizar esta ação?</p>

        <!-- Campo de observações (opcional) -->
        <div id="confirmation-input-container" class="mb-4 hidden">
          <label class="block text-sm font-medium ds-modal-muted mb-2" id="confirmation-input-label">Observações</label>
          <textarea id="confirmation-input" rows="3" class="w-full px-3 py-2 rounded-lg ds-modal-input focus:ring-2 focus:ring-accent focus:border-accent" placeholder="Digite suas observações..."></textarea>
        </div>
      </div>

      <!-- Footer com botões -->
      <div class="px-6 pb-6 flex flex-col gap-3">
        <button id="confirmation-confirm" class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors">
          Confirmar
        </button>
        <button id="confirmation-cancel" class="w-full px-4 py-3 ds-modal-muted hover:ds-modal-text font-medium rounded-lg transition-colors">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
  // Função para abrir modal de detalhes
  function openProcessoModal(processoId) {
    console.log('Tentando abrir modal para processo:', processoId);
    
    const modal = document.getElementById('processo-modal');
    const modalContent = document.getElementById('modal-content');
    
    console.log('Elementos do modal encontrados:', { modal: !!modal, modalContent: !!modalContent });
    
    // Verificar se os elementos existem
    if (!modal || !modalContent) {
      console.error('Elementos do modal não encontrados:', { modal: !!modal, modalContent: !!modalContent });
      return;
    }
    
    console.log('Modal aberto, carregando conteúdo...');
    
    // Mostrar modal com loading
    modalContent.innerHTML = `
      <div class="ds-card">
        <div class="p-8 text-center">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
          <p class="text-gray-400">Carregando detalhes...</p>
        </div>
      </div>
    `;
    
    // Mostrar modal
    modal.classList.remove('opacity-0', 'invisible');
    modal.classList.add('opacity-100', 'visible');
    
    // Animar o modal
    const modalDialog = modal.querySelector('div > div');
    if (modalDialog) {
      modalDialog.classList.remove('scale-95');
      modalDialog.classList.add('scale-100');
    }
    
    document.body.style.overflow = 'hidden';
    
    // Carregar conteúdo do modal
    fetch(`/tesouraria/processos/${processoId}/modal/`)
      .then(response => {
        console.log('Resposta recebida:', response.status);
        return response.text();
      })
      .then(html => {
        console.log('HTML recebido, atualizando modal...');
        if (modalContent) {
          modalContent.innerHTML = html;
        }
      })
      .catch(error => {
        console.error('Erro ao carregar modal:', error);
        if (modalContent) {
          modalContent.innerHTML = `
            <div class="ds-card">
              <div class="p-8 text-center">
                <div class="text-red-500 mb-4">
                  <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                  </svg>
                </div>
                <p class="text-gray-400 mb-4">Erro ao carregar detalhes do processo</p>
                <button onclick="closeModal()" class="btn btn-ghost">Fechar</button>
              </div>
            </div>
          `;
        }
      });
  }

  // Função para fechar modal
  function closeModal(event) {
    if (event && event.target !== event.currentTarget) return;
    
    const modal = document.getElementById('processo-modal');
    if (modal) {
      // Animar o fechamento
      const modalDialog = modal.querySelector('div > div');
      if (modalDialog) {
        modalDialog.classList.remove('scale-100');
        modalDialog.classList.add('scale-95');
      }
      
      modal.classList.add('opacity-0', 'invisible');
      modal.classList.remove('opacity-100', 'visible');
      document.body.style.overflow = '';
    }
  }

  // Fechar modal com ESC
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeModal();
    }
  });

  // Filter manager
  function filterManager() {
    return {
      showAdvanced: false,

      toggleAdvanced() {
        this.showAdvanced = !this.showAdvanced;
      },

      resetAdvanced() {
        const advancedForm = document.querySelectorAll('[x-show="showAdvanced"] input, [x-show="showAdvanced"] select');
        advancedForm.forEach(field => {
          if (field.type === 'date' || field.type === 'number' || field.type === 'text') {
            field.value = '';
          } else if (field.tagName === 'SELECT') {
            field.selectedIndex = 0;
          }
        });
      }
    }
  }

  // Sistema de confirmação modal padronizado
  function showConfirmationModal(options) {
    const modal = document.getElementById('confirmation-modal');
    const icon = document.getElementById('confirmation-icon');
    const title = document.getElementById('confirmation-title');
    const message = document.getElementById('confirmation-message');
    const inputContainer = document.getElementById('confirmation-input-container');
    const inputLabel = document.getElementById('confirmation-input-label');
    const input = document.getElementById('confirmation-input');
    const confirmBtn = document.getElementById('confirmation-confirm');
    const cancelBtn = document.getElementById('confirmation-cancel');

    // Configurar ícone e cores do botão
    const iconColors = {
      success: 'bg-emerald-500/20 text-emerald-400',
      warning: 'bg-amber-500/20 text-amber-400',
      danger: 'bg-red-500/20 text-red-400',
      info: 'bg-blue-500/20 text-blue-400'
    };

    const buttonColors = {
      success: 'bg-emerald-600 hover:bg-emerald-700',
      warning: 'bg-amber-600 hover:bg-amber-700',
      danger: 'bg-red-600 hover:bg-red-700',
      info: 'bg-blue-600 hover:bg-blue-700'
    };

    const icons = {
      success: '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
      warning: '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>',
      danger: '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
      info: '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
    };

    // Aplicar configurações
    icon.className = `w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center ${iconColors[options.type] || iconColors.info}`;
    icon.innerHTML = icons[options.type] || icons.info;
    title.textContent = options.title || 'Confirmar Ação';
    message.textContent = options.message || 'Tem certeza que deseja realizar esta ação?';

    // Configurar campo de input se necessário
    if (options.showInput) {
      inputContainer.classList.remove('hidden');
      inputLabel.textContent = options.inputLabel || 'Observações';
      input.placeholder = options.inputPlaceholder || 'Digite suas observações...';
      input.value = '';
    } else {
      inputContainer.classList.add('hidden');
    }

    // Configurar botões
    confirmBtn.textContent = options.confirmText || 'Confirmar';
    confirmBtn.className = `w-full px-4 py-3 text-white font-medium rounded-lg transition-colors ${buttonColors[options.type] || buttonColors.info}`;
    cancelBtn.textContent = options.cancelText || 'Cancelar';

    // Event listeners
    const handleConfirm = () => {
      const inputValue = options.showInput ? input.value : null;
      closeConfirmationModal();
      if (options.onConfirm) {
        options.onConfirm(inputValue);
      }
    };

    const handleCancel = () => {
      closeConfirmationModal();
      if (options.onCancel) {
        options.onCancel();
      }
    };

    // Remover listeners anteriores
    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
    cancelBtn.replaceWith(cancelBtn.cloneNode(true));

    // Adicionar novos listeners
    document.getElementById('confirmation-confirm').addEventListener('click', handleConfirm);
    document.getElementById('confirmation-cancel').addEventListener('click', handleCancel);

    // Mostrar modal
    modal.classList.remove('opacity-0', 'invisible');
    modal.classList.add('opacity-100', 'visible');
    const modalDialog = modal.querySelector('div > div');
    if (modalDialog) {
      modalDialog.classList.remove('scale-95');
      modalDialog.classList.add('scale-100');
    }
  }

  function closeConfirmationModal() {
    const modal = document.getElementById('confirmation-modal');
    const modalDialog = modal.querySelector('div > div');
    if (modalDialog) {
      modalDialog.classList.remove('scale-100');
      modalDialog.classList.add('scale-95');
    }
    modal.classList.add('opacity-0', 'invisible');
    modal.classList.remove('opacity-100', 'visible');
  }

  // Funções para ações dos processos da tesouraria
  function salvarObservacoes(processoId) {
    const observacoes = document.querySelector('textarea[name="observacoes_tesouraria"]').value;

    fetch(`/tesouraria/processos/${processoId}/observacoes/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ observacoes: observacoes })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Observações salvas com sucesso!');
      } else {
        alert('Erro ao salvar observações: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao salvar observações');
    });
  }

  function efetivarContrato(processoId) {
    showConfirmationModal({
      type: 'success',
      title: 'Efetivar Contrato',
      message: 'O contrato será aprovado e encaminhado para a tesouraria.',
      confirmText: 'Confirmar Efetivação',
      onConfirm: () => {
        const formData = new FormData();

        // Adicionar comprovantes se selecionados
        const comprovanteAssociadoInput = document.querySelector('input[name="comprovante_associado"]');
        const comprovanteAgenteInput = document.querySelector('input[name="comprovante_agente"]');
        const observacoesTextarea = document.querySelector('textarea[name="observacoes_tesouraria"]');

        if (comprovanteAssociadoInput && comprovanteAssociadoInput.files[0]) {
          formData.append('comprovante_associado', comprovanteAssociadoInput.files[0]);
        }
        if (comprovanteAgenteInput && comprovanteAgenteInput.files[0]) {
          formData.append('comprovante_agente', comprovanteAgenteInput.files[0]);
        }
        if (observacoesTextarea && observacoesTextarea.value) {
          formData.append('observacoes_efetivacao', observacoesTextarea.value);
        }

        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch(`/tesouraria/processos/${processoId}/efetivar/`, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            alert('Contrato efetivado com sucesso!');
            closeModal();
            location.reload();
          } else {
            alert('Erro ao efetivar contrato');
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          alert('Erro ao efetivar contrato');
        });
      }
    });
  }

  function cancelarContrato(processoId) {
    showConfirmationModal({
      type: 'danger',
      title: 'Cancelar Contrato',
      message: 'O contrato será cancelado definitivamente.',
      showInput: true,
      inputLabel: 'Motivo do cancelamento (obrigatório)',
      inputPlaceholder: 'Informe o motivo do cancelamento...',
      confirmText: 'Confirmar Cancelamento',
      onConfirm: (motivo) => {
        if (!motivo || motivo.trim() === '') {
          alert('O motivo do cancelamento é obrigatório');
          return;
        }

        const formData = new FormData();
        formData.append('observacoes_cancelamento', motivo);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch(`/tesouraria/processos/${processoId}/cancelar/`, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            alert('Contrato cancelado com sucesso!');
            closeModal();
            location.reload();
          } else {
            alert('Erro ao cancelar contrato');
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          alert('Erro ao cancelar contrato');
        });
      }
    });
  }

  function devolverAnalise(processoId) {
    showConfirmationModal({
      type: 'warning',
      title: 'Devolver para Análise',
      message: 'O processo será devolvido para análise.',
      showInput: true,
      inputLabel: 'Motivo da devolução (obrigatório)',
      inputPlaceholder: 'Informe o motivo da devolução...',
      confirmText: 'Confirmar Devolução',
      onConfirm: (motivo) => {
        if (!motivo || motivo.trim() === '') {
          alert('O motivo da devolução é obrigatório');
          return;
        }

        const formData = new FormData();
        formData.append('observacoes_devolucao', motivo);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch(`/tesouraria/processos/${processoId}/devolver/`, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            alert('Processo devolvido para análise com sucesso!');
            closeModal();
            location.reload();
          } else {
            alert('Erro ao devolver processo');
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          alert('Erro ao devolver processo');
        });
      }
    });
  }

  function validacaoVideo(processoId) {
    showConfirmationModal({
      type: 'info',
      title: 'Validação Vídeo',
      message: 'O processo será marcado como "Em Validação Vídeo".',
      showInput: true,
      inputLabel: 'Observações da validação vídeo (opcional)',
      inputPlaceholder: 'Observações sobre a validação de vídeo...',
      confirmText: 'Confirmar Validação Vídeo',
      onConfirm: (observacoes) => {
        fetch(`/tesouraria/processos/${processoId}/validacao-video/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ observacoes_validacao: observacoes || '' })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Status alterado para "Em Validação Vídeo" com sucesso!');
            location.reload();
          } else {
            alert('Erro ao alterar status: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          alert('Erro ao alterar status para validação de vídeo');
        });
      }
    });
  }

  function averbacao(processoId) {
    showConfirmationModal({
      type: 'info',
      title: 'Averbação',
      message: 'O processo será marcado como "Em Averbação".',
      showInput: true,
      inputLabel: 'Observações da averbação (opcional)',
      inputPlaceholder: 'Observações sobre a averbação...',
      confirmText: 'Confirmar Averbação',
      onConfirm: (observacoes) => {
        fetch(`/tesouraria/processos/${processoId}/averbacao/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ observacoes_averbacao: observacoes || '' })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Status alterado para "Em Averbação" com sucesso!');
            location.reload();
          } else {
            alert('Erro ao alterar status: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          alert('Erro ao alterar status para averbação');
        });
      }
    });
  }
</script>
{% endblock extra_js %}