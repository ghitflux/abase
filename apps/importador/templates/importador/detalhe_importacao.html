{% extends 'base.html' %}

{% block title %}Detalhes da Importação{% endblock %}

{% block content %}
<div class="p-6">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Detalhes da Importação</h1>
            <a href="{% url 'importador:listar_importacoes' %}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Voltar
            </a>
        </div>
        
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Informações Gerais</h2>
            </div>
            <div class="px-6 py-4">
                <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Arquivo</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ importacao.nome_arquivo }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Tipo</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ importacao.get_tipo_arquivo_display }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Competência</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ importacao.competencia }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Status</dt>
                        <dd class="mt-1">
                            {% if importacao.status == 'CONCLUIDO' %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Concluído</span>
                            {% elif importacao.status == 'PROCESSANDO' %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Processando</span>
                            {% elif importacao.status == 'ERRO' %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Erro</span>
                            {% else %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Pendente</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Enviado por</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ importacao.usuario.get_full_name|default:importacao.usuario.username }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Data do Upload</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ importacao.data_upload|date:'d/m/Y H:i:s' }}</dd>
                    </div>
                    {% if importacao.data_processamento %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Data do Processamento</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ importacao.data_processamento|date:'d/m/Y H:i:s' }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>
        </div>
        
        {% if importacao.total_linhas > 0 %}
        <div class="mt-6 bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Estatísticas do Processamento</h2>
            </div>
            <div class="px-6 py-4">
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                    <div class="border-l-4 border-blue-500 pl-4">
                        <div class="text-2xl font-bold text-blue-600">{{ importacao.total_linhas }}</div>
                        <div class="text-sm text-gray-600">Total de Linhas</div>
                    </div>
                    <div class="border-l-4 border-green-500 pl-4">
                        <div class="text-2xl font-bold text-green-600">{{ importacao.linhas_processadas }}</div>
                        <div class="text-sm text-gray-600">Processadas com Sucesso</div>
                    </div>
                    <div class="border-l-4 border-red-500 pl-4">
                        <div class="text-2xl font-bold text-red-600">{{ importacao.linhas_com_erro }}</div>
                        <div class="text-sm text-gray-600">Com Erro</div>
                    </div>
                </div>
                
                {% if importacao.total_linhas > 0 %}
                <div class="mt-6">
                    <div class="text-sm font-medium text-gray-700 mb-2">Taxa de Sucesso</div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: {% widthratio importacao.linhas_processadas importacao.total_linhas 100 %}%"></div>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        {% widthratio importacao.linhas_processadas importacao.total_linhas 100 %}% de sucesso
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% if importacao.log_erros %}
        <div class="mt-6 bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Log de Erros</h2>
            </div>
            <div class="px-6 py-4">
                <div class="bg-red-50 border border-red-200 rounded-md p-4">
                    <pre class="text-xs text-red-800 whitespace-pre-wrap overflow-x-auto">{{ importacao.log_erros }}</pre>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if importacao.status == 'ERRO' %}
        <div class="mt-6 flex justify-end">
            <form method="post" action="{% url 'importador:reprocessar_arquivo' importacao.id %}">
                {% csrf_token %}
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Reprocessar Arquivo
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}